#!/bin/bash

# OpenCode Lens - OpenCode with Arize Phoenix observability
# 
# Usage: ./opencode-lens [--proxy-url URL] [opencode args...]
#
# Configuration (precedence: highest to lowest):
#   1. --proxy-url URL              Override proxy URL via command line
#   2. OPENCODE_LENS_PROXY_URL      Environment variable
#   3. http://localhost:4000        Default proxy URL
#
# Examples:
#   ./opencode-lens
#   ./opencode-lens --proxy-url http://remote-server:4000
#   OPENCODE_LENS_PROXY_URL=http://remote:4000 ./opencode-lens
#
# All other arguments are passed to OpenCode.

set -e

# Parse command line arguments
PROXY_URL=""
OPENCODE_ARGS=()

while [[ $# -gt 0 ]]; do
    case $1 in
        --proxy-url)
            PROXY_URL="$2"
            shift 2
            ;;
        *)
            OPENCODE_ARGS+=("$1")
            shift
            ;;
    esac
done

# Determine proxy URL with precedence order
FINAL_PROXY_URL="${PROXY_URL:-${OPENCODE_LENS_PROXY_URL:-http://localhost:4000}}"

# Health checks - exit on first failure
echo -n "[ ] LiteLLM proxy responding... "
if curl -s "$FINAL_PROXY_URL/health" >/dev/null 2>&1; then
    echo "[✓]"
else
    echo "[✗]"
    exit 1
fi

echo -n "[ ] OpenCode config valid... "
if grep -q "$FINAL_PROXY_URL" opencode.json 2>/dev/null; then
    echo "[✓]"
else
    echo "[✗]"
    exit 1
fi

echo "[→] Starting OpenCode..."

# Wrap opencode execution with script for TTY emulation
# The script command records terminal output and simulates a TTY session
script -q -c "opencode ${OPENCODE_ARGS[*]}" /tmp/opencode.log
